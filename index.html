<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>營養補充品標籤分析器 - AI驅動的個人化營養建議系統</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="AI驅動的營養補充品標籤分析器，提供個人化營養建議和品牌推薦。上傳營養標籤圖片，即時獲得專業的營養素功效分析。">
    <meta name="keywords" content="營養補充品,AI分析,健康建議,維他命,個人化推薦,營養標籤,健康管理,品牌認證">
    <meta name="author" content="Nutrition Analyzer">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://nutrition-analyzer.netlify.app/">
    <meta property="og:title" content="營養補充品標籤分析器 - AI個人化營養建議">
    <meta property="og:description" content="AI驅動的營養補充品分析和推薦系統，幫助您找到最適合的健康補充品">
    <meta property="og:image" content="https://nutrition-analyzer.netlify.app/og-image.jpg">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://nutrition-analyzer.netlify.app/">
    <meta property="twitter:title" content="營養補充品標籤分析器 - AI個人化營養建議">
    <meta property="twitter:description" content="AI驅動的營養補充品分析和推薦系統，幫助您找到最適合的健康補充品">
    <meta property="twitter:image" content="https://nutrition-analyzer.netlify.app/og-image.jpg">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🏷️</text></svg>">
    
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4B4BC8'
                    }
                }
            }
        }
    </script>
    
    <!-- Custom Styles -->
    <style>
        .markdown-content h3 {
            @apply text-lg font-semibold mt-4 mb-2 text-gray-800 dark:text-gray-200;
        }
        .markdown-content h4 {
            @apply text-base font-medium mt-3 mb-1 text-gray-700 dark:text-gray-300;
        }
        .markdown-content ul {
            @apply list-disc pl-5 space-y-1 text-gray-600 dark:text-gray-400;
        }
        .markdown-content li {
            @apply text-sm leading-relaxed;
        }
        .markdown-content p {
            @apply text-sm text-gray-600 dark:text-gray-400 mb-2;
        }
        .markdown-content strong {
            @apply font-semibold text-gray-800 dark:text-gray-200;
        }
        .markdown-content a {
            @apply text-primary hover:text-primary-dark underline;
        }
        
        /* Loading animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* Smooth transitions */
        .transition-all {
            transition: all 0.3s ease;
        }
        
        /* Focus styles for accessibility */
        .focus-ring:focus {
            @apply outline-none ring-2 ring-primary ring-offset-2;
        }
    </style>
    
    <!-- Google Analytics (Replace GA_MEASUREMENT_ID with your actual ID) -->
    <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'GA_MEASUREMENT_ID');
    </script> -->
</head>
<body class="bg-white dark:bg-gray-900 transition-colors duration-300">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-primary dark:bg-primary-dark text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <h1 class="text-2xl md:text-3xl font-bold text-center">🏷️ 營養補充品標籤分析器</h1>
                <p class="text-center mt-2 text-primary-100 text-sm md:text-base">AI驅動的個人化營養建議系統 - 上傳營養標籤圖片，即時獲得專業分析</p>
            </div>
        </header>

        <main class="container mx-auto px-4 py-8 max-w-4xl">
            <!-- Personal Information Section -->
            <div class="bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 rounded-lg p-6 mb-8 border border-purple-200 dark:border-purple-800">
                <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200 flex items-center">
                    <span class="mr-2">👤</span>
                    個人資料 (可選，用於個人化建議)
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Gender -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">性別</label>
                        <select id="gender" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus-ring">
                            <option value="">請選擇</option>
                            <option value="male">男性</option>
                            <option value="female">女性</option>
                        </select>
                    </div>
                    
                    <!-- Age -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">年齡</label>
                        <input type="number" id="age" min="1" max="120" placeholder="例: 30" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus-ring">
                    </div>
                    
                    <!-- Height -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">身高 (cm)</label>
                        <input type="number" id="height" min="50" max="250" placeholder="例: 170" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus-ring">
                    </div>
                    
                    <!-- Weight -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">體重 (kg)</label>
                        <input type="number" id="weight" min="20" max="300" step="0.1" placeholder="例: 65" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus-ring">
                    </div>
                    
                    <!-- Activity Level -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">活動量</label>
                        <select id="activityLevel" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus-ring">
                            <option value="">請選擇</option>
                            <option value="sedentary">久坐 (很少運動)</option>
                            <option value="light">輕度 (每週1-3次運動)</option>
                            <option value="moderate">中度 (每週3-5次運動)</option>
                            <option value="active">高度 (每週6-7次運動)</option>
                            <option value="very_active">極高 (每天運動或體力工作)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Medical Conditions -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">長期病患或健康狀況</label>
                    <textarea id="medicalConditions" rows="3" placeholder="例: 高血壓、糖尿病、心臟病、腎臟病、懷孕、哺乳等... (沒有請留空)" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus-ring"></textarea>
                </div>
                
                <!-- Current Medications -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">目前服用的藥物或其他補充品</label>
                    <textarea id="currentMedications" rows="2" placeholder="例: 降血壓藥、維他命D、魚油等... (沒有請留空)" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus-ring"></textarea>
                </div>

                <!-- Health Goals -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">想要改善的健康問題 (可多選)</label>
                    
                    <!-- Common Health Issues Checkboxes -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 mb-3">
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded transition-all">
                            <input type="checkbox" id="skinIssues" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">皮膚問題</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded transition-all">
                            <input type="checkbox" id="weightLoss" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">減肥瘦身</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded transition-all">
                            <input type="checkbox" id="jointPain" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">關節疼痛</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded transition-all">
                            <input type="checkbox" id="sciatica" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">坐骨神經痛</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded transition-all">
                            <input type="checkbox" id="immunity" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">提升免疫力</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded transition-all">
                            <input type="checkbox" id="energy" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">增加體力</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded transition-all">
                            <input type="checkbox" id="sleep" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">改善睡眠</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded transition-all">
                            <input type="checkbox" id="digestion" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">消化問題</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded transition-all">
                            <input type="checkbox" id="memory" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">增強記憶</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded transition-all">
                            <input type="checkbox" id="stress" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">舒緩壓力</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded transition-all">
                            <input type="checkbox" id="heartHealth" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">心血管健康</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded transition-all">
                            <input type="checkbox" id="eyeHealth" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">護眼明目</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded transition-all">
                            <input type="checkbox" id="boneHealth" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">骨骼健康</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded transition-all">
                            <input type="checkbox" id="hairHealth" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">頭髮健康</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded transition-all">
                            <input type="checkbox" id="bloodSugar" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">血糖控制</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded transition-all">
                            <input type="checkbox" id="cholesterol" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">膽固醇管理</span>
                        </label>
                    </div>

                    <!-- Custom Health Goals -->
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">其他健康目標</label>
                        <textarea id="customHealthGoals" rows="2" placeholder="例: 改善更年期症狀、緩解偏頭痛、提升運動表現等... (沒有請留空)" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus-ring"></textarea>
                    </div>
                </div>

                <!-- AI Smart Features -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">🤖 AI智能功能偏好 (可選，提升個人化體驗)</label>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-3 rounded transition-all">
                            <input type="checkbox" id="aiPersonalized" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">📊 AI個人化分析</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-3 rounded transition-all">
                            <input type="checkbox" id="smartRecommendation" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">🧠 智能產品推薦引擎</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-3 rounded transition-all">
                            <input type="checkbox" id="oneClickShopping" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">🛒 一鍵購物整合</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-3 rounded transition-all">
                            <input type="checkbox" id="progressTracking" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">📈 健康成效追蹤</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-3 rounded transition-all">
                            <input type="checkbox" id="brandPartnership" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">🤝 品牌合作優惠</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-3 rounded transition-all">
                            <input type="checkbox" id="premiumMembership" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">👑 高級會員訂閱</span>
                        </label>
                    </div>

                    <div class="mb-3 p-3 bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 border border-purple-200 dark:border-purple-800 rounded-md">
                        <p class="text-xs font-medium text-purple-800 dark:text-purple-200 mb-2">🚀 智能功能說明</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-purple-700 dark:text-purple-300">
                            <div>• 📊 基於健康數據的AI深度分析</div>
                            <div>• 🛒 直接購買連結，享受獨家優惠</div>
                            <div>• 📈 追蹤使用效果和健康改善進度</div>
                            <div>• 🤝 品牌合作專屬折扣和新品搶先</div>
                            <div>• 👑 專業營養師線上諮詢服務</div>
                            <div>• 🔬 最新營養科學研究資訊推送</div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Budget -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">💰 每月營養補充品預算 (可選，AI將推薦最適合的品牌組合)</label>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-3 rounded transition-all">
                            <input type="radio" name="budget" id="budget1" value="under650" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">HK$ 650 以下</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-3 rounded transition-all">
                            <input type="radio" name="budget" id="budget2" value="650-1000" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">HK$ 650-1,000</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-3 rounded transition-all">
                            <input type="radio" name="budget" id="budget3" value="1000-1500" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">HK$ 1,000-1,500</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-3 rounded transition-all">
                            <input type="radio" name="budget" id="budget4" value="over1500" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 focus-ring">
                            <span class="text-sm text-gray-700 dark:text-gray-300">HK$ 1,500 以上</span>
                        </label>
                    </div>

                    <div class="mb-3 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-md">
                        <p class="text-xs font-medium text-green-800 dark:text-green-200 mb-2">💰 預算對應AI推薦方案</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-green-700 dark:text-green-300">
                            <div>• HK$ 650以下：經濟實惠智能組合</div>
                            <div>• HK$ 650-1,000：經濟實惠進階AI組合</div>
                            <div>• HK$ 1,000-1,500：優質平衡智能組合</div>
                            <div>• HK$ 1,500以上：頂級專業AI組合</div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">自訂每月預算 (可選)</label>
                        <input type="number" id="customBudget" min="100" max="5000" placeholder="例: 800" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus-ring">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">AI將根據您的精確預算提供最佳化推薦</p>
                    </div>
                </div>

                <!-- Specific Improvement Targets -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">具體改善目標 (可選，有助於更精準的建議)</label>
                    
                    <!-- Common Target Examples -->
                    <div class="mb-3 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-md">
                        <p class="text-xs font-medium text-blue-800 dark:text-blue-200 mb-2">💡 建議格式：時間 + 具體目標</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-blue-700 dark:text-blue-300">
                            <div>• 三個月內減肥20磅</div>
                            <div>• 六週內改善睡眠品質</div>
                            <div>• 兩個月內血糖回復正常</div>
                            <div>• 一個月內減少關節疼痛</div>
                            <div>• 四週內提升體力和精神</div>
                            <div>• 三個月內改善皮膚狀況</div>
                        </div>
                    </div>

                    <!-- Target Input Fields -->
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">目標 1</label>
                            <input type="text" id="target1" placeholder="例: 三個月內減肥20磅" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus-ring">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">目標 2</label>
                            <input type="text" id="target2" placeholder="例: 兩個月內血糖回復正常水平" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus-ring">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">目標 3</label>
                            <input type="text" id="target3" placeholder="例: 六週內改善睡眠品質，每晚睡足7小時" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus-ring">
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-md">
                    <p class="text-sm text-yellow-800 dark:text-yellow-200">
                        ⚠️ <strong>重要提醒：</strong>此分析僅供參考，不能取代專業醫療建議。如有健康問題或正在服用藥物，請諮詢醫生或營養師。
                    </p>
                </div>
            </div>

            <!-- Upload Section -->
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">📸 上傳營養標籤圖片</h2>
                
                <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center hover:border-primary transition-colors duration-300">
                    <input type="file" id="imageInput" accept="image/*" class="hidden">
                    <label for="imageInput" class="cursor-pointer">
                        <div class="space-y-4">
                            <div class="text-4xl">📷</div>
                            <div>
                                <p class="text-lg font-medium text-gray-700 dark:text-gray-300">點擊選擇圖片</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">支援 JPG, PNG, WebP 格式，最大10MB</p>
                            </div>
                        </div>
                    </label>
                </div>

                <!-- Preview -->
                <div id="imagePreview" class="mt-4 hidden">
                    <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">圖片預覽：</h3>
                    <img id="previewImg" class="max-w-full h-auto max-h-64 rounded-lg shadow-md mx-auto">
                </div>

                <!-- Action Buttons -->
                <div class="mt-6 space-y-3">
                    <button id="analyzeBtn" class="w-full bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed hidden focus-ring">
                        🔍 分析營養標籤
                    </button>
                    
                    <button id="recommendBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed focus-ring">
                        💊 獲取營養產品推薦
                    </button>
                    
                    <p class="text-xs text-gray-500 dark:text-gray-400 text-center">
                        上傳圖片可分析現有產品，或直接獲取推薦
                    </p>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="hidden bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-6 mb-8">
                <div class="flex items-center space-x-3">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                    <span class="text-blue-700 dark:text-blue-300">正在分析營養標籤...</span>
                </div>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-6 mb-8">
                <div class="flex items-center space-x-3 mb-3">
                    <span class="text-red-600 dark:text-red-400">❌</span>
                    <span class="text-red-700 dark:text-red-300" id="errorMessage">分析過程中發生錯誤，請稍後再試。</span>
                </div>
                <div id="errorDetails" class="hidden mt-3 p-3 bg-red-100 dark:bg-red-900/40 rounded text-xs text-red-600 dark:text-red-400 font-mono">
                    <!-- Detailed error info will be shown here -->
                </div>
                <button id="showDebugBtn" class="mt-3 text-sm text-red-600 dark:text-red-400 underline hover:no-underline focus-ring">
                    顯示調試資訊
                </button>
            </div>

            <!-- Debug Info -->
            <div id="debugInfo" class="hidden bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 mb-8">
                <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">🔧 調試資訊</h3>
                <div id="debugContent" class="text-xs text-gray-600 dark:text-gray-400 font-mono whitespace-pre-wrap">
                    <!-- Debug info will be shown here -->
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden space-y-6">
                <!-- Product Recommendations -->
                <div id="productRecommendationsSection" class="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg p-6 hidden">
                    <h2 class="text-xl font-semibold mb-4 text-purple-800 dark:text-purple-200 flex items-center">
                        <span class="mr-2">🌟</span>
                        營養產品推薦
                    </h2>
                    <div id="productRecommendations" class="markdown-content">
                        <!-- AI recommendations will be inserted here -->
                    </div>
                </div>

                <!-- Personal Suitability -->
                <div id="personalSuitabilitySection" class="bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800 rounded-lg p-6 hidden">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-800 dark:text-indigo-200 flex items-center">
                        <span class="mr-2">🎯</span>
                        個人化適用性評估
                    </h2>
                    <div id="personalSuitability" class="markdown-content">
                        <!-- AI personal analysis will be inserted here -->
                    </div>
                </div>

                <!-- Nutritional Analysis -->
                <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-green-800 dark:text-green-200 flex items-center">
                        <span class="mr-2">📊</span>
                        營養成分分析
                    </h2>
                    <div id="nutritionalAnalysis" class="markdown-content">
                        <!-- AI analysis will be inserted here -->
                    </div>
                </div>

                <!-- Health Benefits -->
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-blue-800 dark:text-blue-200 flex items-center">
                        <span class="mr-2">💊</span>
                        營養素功效
                    </h2>
                    <div id="healthBenefits" class="markdown-content">
                        <!-- AI analysis will be inserted here -->
                    </div>
                </div>

                <!-- Dosage Recommendations -->
                <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-amber-800 dark:text-amber-200 flex items-center">
                        <span class="mr-2">⚖️</span>
                        建議攝取量
                    </h2>
                    <div id="dosageRecommendations" class="markdown-content">
                        <!-- AI analysis will be inserted here -->
                    </div>
                </div>

                <!-- Safety Information -->
                <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-red-800 dark:text-red-200 flex items-center">
                        <span class="mr-2">⚠️</span>
                        注意事項
                    </h2>
                    <div id="safetyInfo" class="markdown-content">
                        <!-- AI analysis will be inserted here -->
                    </div>
                </div>

                <!-- Reset Button -->
                <div class="text-center pt-4">
                    <button id="resetBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg transition-colors duration-200 focus-ring">
                        🔄 分析新的標籤
                    </button>
                </div>
            </div>

            <!-- Tips Section -->
            <div class="mt-12 bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                <h2 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200">💡 使用小貼士</h2>
                <ul class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
                    <li>• 確保標籤文字清晰可見，避免模糊或反光</li>
                    <li>• 建議拍攝完整的營養成分表</li>
                    <li>• 如果標籤很小，可以近距離拍攝提高清晰度</li>
                    <li>• 支援中文、英文等多種語言的營養標籤</li>
                    <li>• 填寫個人資料可獲得更精準的個人化建議</li>
                </ul>
            </div>

            <!-- Features Section -->
            <div class="mt-8 bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 rounded-lg p-6">
                <h2 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200 text-center">🚀 核心功能特色</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="text-center p-4">
                        <div class="text-3xl mb-2">🤖</div>
                        <h3 class="font-semibold text-gray-800 dark:text-gray-200 mb-1">AI智能分析</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">先進的AI技術識別營養標籤並提供專業分析</p>
                    </div>
                    <div class="text-center p-4">
                        <div class="text-3xl mb-2">🎯</div>
                        <h3 class="font-semibold text-gray-800 dark:text-gray-200 mb-1">個人化建議</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">根據個人健康狀況提供量身定制的營養建議</p>
                    </div>
                    <div class="text-center p-4">
                        <div class="text-3xl mb-2">🏅</div>
                        <h3 class="font-semibold text-gray-800 dark:text-gray-200 mb-1">品牌認證</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">推薦經過USP、NSF、GMP認證的可信品牌</p>
                    </div>
                    <div class="text-center p-4">
                        <div class="text-3xl mb-2">💰</div>
                        <h3 class="font-semibold text-gray-800 dark:text-gray-200 mb-1">預算優化</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">根據預算推薦最具性價比的營養組合</p>
                    </div>
                    <div class="text-center p-4">
                        <div class="text-3xl mb-2">📈</div>
                        <h3 class="font-semibold text-gray-800 dark:text-gray-200 mb-1">成效追蹤</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">量化健康改善進度，動態調整建議</p>
                    </div>
                    <div class="text-center p-4">
                        <div class="text-3xl mb-2">🛒</div>
                        <h3 class="font-semibold text-gray-800 dark:text-gray-200 mb-1">購物整合</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">一鍵連結可信購物平台，享受專屬優惠</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-100 dark:bg-gray-800 py-8 mt-12">
            <div class="container mx-auto px-4 text-center">
                <div class="text-gray-600 dark:text-gray-400 text-sm space-y-2">
                    <p>© 2024 營養補充品標籤分析器 - AI驅動的個人化營養建議系統</p>
                    <p>本服務僅供參考，不能取代專業醫療建議 | <a href="mailto:contact@nutrition-analyzer.app" class="text-primary hover:underline">聯繫我們</a></p>
                    <div class="flex justify-center space-x-4 text-xs">
                        <a href="#" class="hover:text-primary">隱私政策</a>
                        <a href="#" class="hover:text-primary">服務條款</a>
                        <a href="#" class="hover:text-primary">關於我們</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Dark mode detection and toggle
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // DOM elements
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const recommendBtn = document.getElementById('recommendBtn');
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const errorMessage = document.getElementById('errorMessage');
        const resultsSection = document.getElementById('resultsSection');
        const resetBtn = document.getElementById('resetBtn');

        let selectedFile = null;
        let debugLog = [];

        // Google Analytics Event Tracking
        function trackEvent(action, category, label) {
            if (typeof gtag !== 'undefined') {
                gtag('event', action, {
                    'event_category': category,
                    'event_label': label || 'Nutrition Analyzer'
                });
            }
        }

        // Debug logging function
        function addDebugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLog.push(logEntry);
            if (data) {
                debugLog.push(`    Data: ${JSON.stringify(data)}`);
            }
            console.log(logEntry, data);
            updateDebugDisplay();
        }

        function updateDebugDisplay() {
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                debugContent.textContent = debugLog.join('\n');
            }
        }

        // Debug button event
        document.getElementById('showDebugBtn').addEventListener('click', function() {
            const debugInfo = document.getElementById('debugInfo');
            const errorDetails = document.getElementById('errorDetails');
            if (debugInfo.classList.contains('hidden')) {
                debugInfo.classList.remove('hidden');
                errorDetails.classList.remove('hidden');
                this.textContent = '隱藏調試資訊';
            } else {
                debugInfo.classList.add('hidden');
                errorDetails.classList.add('hidden');
                this.textContent = '顯示調試資訊';
            }
        });

        // Initialize debug
        addDebugLog('應用程式啟動');

        // Image compression function
        function compressImage(file, maxSizeMB = 2, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate new dimensions
                    let { width, height } = img;
                    const maxDimension = 1200; // Max width or height
                    
                    if (width > height && width > maxDimension) {
                        height = (height * maxDimension) / width;
                        width = maxDimension;
                    } else if (height > maxDimension) {
                        width = (width * maxDimension) / height;
                        height = maxDimension;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob(
                        (blob) => {
                            if (blob) {
                                addDebugLog('圖片壓縮完成', {
                                    originalSize: file.size,
                                    compressedSize: blob.size,
                                    compressionRatio: (blob.size / file.size * 100).toFixed(1) + '%'
                                });
                                
                                // Create new file with compressed data
                                const compressedFile = new File([blob], file.name, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                });
                                resolve(compressedFile);
                            } else {
                                reject(new Error('圖片壓縮失敗'));
                            }
                        },
                        'image/jpeg',
                        quality
                    );
                };
                
                img.onerror = () => reject(new Error('無法載入圖片進行壓縮'));
                img.src = URL.createObjectURL(file);
            });
        }

        // Handle file selection
        imageInput.addEventListener('change', async function(e) {
            addDebugLog('檔案輸入框變更事件');
            const file = e.target.files[0];
            if (file) {
                addDebugLog('檔案已選擇', {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    lastModified: file.lastModified
                });
                
                // Check file type
                if (!file.type.startsWith('image/')) {
                    addDebugLog('檔案類型錯誤', { type: file.type });
                    showError('請選擇圖片文件 (JPG, PNG, WebP)', `檔案類型: ${file.type}`);
                    return;
                }
                
                // Check file size
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    showError('圖片文件過大，請選擇小於 10MB 的圖片');
                    return;
                }
                
                try {
                    // Compress image if it's too large
                    let processedFile = file;
                    if (file.size > 1024 * 1024) { // If larger than 1MB
                        addDebugLog('檔案過大，開始壓縮');
                        processedFile = await compressImage(file);
                    }
                    
                    selectedFile = processedFile;
                    
                    addDebugLog('開始讀取檔案預覽');
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        addDebugLog('檔案預覽載入完成', {
                            resultLength: e.target.result.length,
                            resultType: typeof e.target.result
                        });
                        previewImg.src = e.target.result;
                        imagePreview.classList.remove('hidden');
                        analyzeBtn.classList.remove('hidden');
                        hideError();
                        
                        // Track file upload event
                        trackEvent('file_upload', 'user_interaction', 'image_selected');
                    };
                    reader.onerror = function(error) {
                        addDebugLog('檔案讀取錯誤', error);
                        showError('無法讀取選擇的圖片文件', `錯誤: ${error}`);
                    };
                    reader.readAsDataURL(processedFile);
                    
                } catch (error) {
                    addDebugLog('檔案處理錯誤', error);
                    showError('處理圖片時發生錯誤', error.message);
                }
            } else {
                addDebugLog('未選擇檔案');
                selectedFile = null;
                imagePreview.classList.add('hidden');
                analyzeBtn.classList.add('hidden');
            }
        });

        // Check if we're running on Poe platform or standalone
        function checkPlatform() {
            if (typeof window.Poe !== 'undefined') {
                return 'poe';
            } else {
                return 'standalone';
            }
        }

        // Initialize platform-specific handlers
        function initializePlatform() {
            const platform = checkPlatform();
            
            if (platform === 'poe') {
                initializePoeHandlers();
            } else {
                initializeStandaloneMode();
            }
            
            return platform;
        }

        function initializeStandaloneMode() {
            console.log('Running in standalone mode');
            
            // Show standalone mode notice
            const standaloneNotice = document.createElement('div');
            standaloneNotice.className = 'bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6';
            standaloneNotice.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="text-blue-600 text-2xl">🌐</div>
                    <div>
                        <h3 class="text-blue-800 dark:text-blue-200 font-semibold text-lg">獨立演示模式</h3>
                        <p class="text-blue-700 dark:text-blue-300 text-sm mt-1">
                            此應用程式正在演示模式下運行，AI分析功能將使用模擬數據。
                            <br>完整AI功能請訪問 <a href="https://poe.com" target="_blank" rel="noopener" class="underline font-medium">Poe平台版本</a>。
                        </p>
                    </div>
                </div>
            `;
            
            const header = document.querySelector('header');
            header.insertAdjacentElement('afterend', standaloneNotice);
        }

        function initializePoeHandlers() {
            // Register AI response handlers for Poe platform
            window.Poe.registerHandler("nutrition-analysis", handleNutritionAnalysis);
            window.Poe.registerHandler("product-recommendations", handleProductRecommendations);
        }

        // Initialize platform and handlers
        const platform = initializePlatform();

        // Standalone mode simulation functions
        function simulateNutritionAnalysis(personalInfo) {
            const mockAnalysis = `
## 營養成分分析
**模擬數據 - 以綜合維他命為例**

### 主要營養成分
- **維他命A** (視黃醇棕櫚酸酯): 5000 IU (100% DV)
- **維他命C** (抗壞血酸): 90mg (100% DV)
- **維他命D3** (膽鈣化醇): 1000 IU (250% DV)
- **維他命E** (dl-α-生育酚醋酸酯): 30 IU (100% DV)
- **維他命K2**: 45mcg
- **B群複合物**:
  - 維他命B1 (硫胺): 1.5mg (100% DV)
  - 維他命B2 (核黃素): 1.7mg (100% DV)
  - 維他命B6 (吡哆醇): 2mg (100% DV)
  - 維他命B12 (氰鈷胺): 6mcg (100% DV)
  - 葉酸: 400mcg (100% DV)
- **礦物質**:
  - 鈣: 200mg (20% DV)
  - 鐵: 18mg (100% DV)
  - 鋅: 15mg (100% DV)
  - 鎂: 100mg (25% DV)

## 營養素功效

### 維他命類
**維他命A**: 維護視力健康、支持免疫系統、促進皮膚健康
**維他命C**: 抗氧化、膠原蛋白合成、提升免疫力
**維他命D3**: 促進鈣質吸收、骨骼健康、免疫調節
**B群維他命**: 能量代謝、神經系統健康、細胞分裂

### 礦物質類
**鈣**: 骨骼和牙齒健康、肌肉收縮、神經傳導
**鐵**: 血液攜氧功能、預防貧血、支持認知功能
**鋅**: 免疫功能、傷口癒合、蛋白質合成
**鎂**: 肌肉和神經功能、血糖調節、蛋白質合成

## 建議攝取量
- **每日建議**: 1粒膠囊，餐後服用
- **最佳時間**: 早餐後30分鐘，提升吸收率
- **注意事項**: 避免空腹服用，可能引起胃部不適
- **配合**: 與充足水分一起服用 (200ml以上)

${personalInfo.bmi ? `## 個人化適用性評估\n**根據您的健康數據分析：**\n- BMI: ${personalInfo.bmi} - ${getBMICategory(personalInfo.bmi)}\n- 此綜合維他命適合您的體質和健康狀況\n- 建議${personalInfo.activityLevel === 'very_active' ? '配合運動後補充' : '規律服用維持健康'}\n${personalInfo.age ? `- 年齡${personalInfo.age}歲適合的劑量和配方` : ''}` : ''}

## 注意事項
⚠️ **重要提醒**:
- 本產品為營養補充品，不能取代均衡飲食
- 孕婦、哺乳期婦女使用前請諮詢醫生
- 服用抗凝血藥物者注意維他命K含量
- 如有慢性疾病，請在醫生指導下使用
- 存放於陰涼乾燥處，避免陽光直射

**此為模擬分析數據，實際產品分析請使用完整版功能**
            `;
            
            return mockAnalysis;
        }

        function getBMICategory(bmi) {
            const bmiNum = parseFloat(bmi);
            if (bmiNum < 18.5) return '體重過輕，建議增加營養攝取';
            if (bmiNum < 24) return '體重正常，維持均衡營養';
            if (bmiNum < 27) return '體重過重，建議配合運動';
            return '肥胖，建議諮詢營養師制定計劃';
        }

        function simulateProductRecommendations(personalInfo) {
            const healthGoals = personalInfo.healthGoals || [];
            const budget = personalInfo.budget || 'HK$ 1,000';
            const smartFeatures = personalInfo.smartFeatures || [];
            
            let recommendationsHTML = `
## 🎯 AI智能營養產品推薦系統

### 🔍 基於您的健康檔案推薦

**個人健康概況：**
${personalInfo.age ? `- 年齡: ${personalInfo.age}歲` : ''}
${personalInfo.gender ? `- 性別: ${personalInfo.gender === 'male' ? '男性' : '女性'}` : ''}
${personalInfo.bmi ? `- BMI: ${personalInfo.bmi}` : ''}
${personalInfo.budget ? `- 每月預算: ${personalInfo.budget}` : ''}
${healthGoals.length > 0 ? `- 健康目標: ${healthGoals.join('、')}` : ''}

### 🎯 針對性推薦方案
            `;

            // Add specific recommendations based on health goals
            if (healthGoals.includes('提升免疫力')) {
                recommendationsHTML += `
**🛡️ 免疫力提升專案：**
- **維他命C 1000mg** - NOW Foods
  - 💰 價格：HK$120/瓶 (60粒，2個月用量)
  - 🏅 認證：GMP認證 + 第三方檢測
  - 🔗 [iHerb優惠購買](https://iherb.com) - 新用戶15% OFF
  - ⏰ 預期效果：4-6週內改善免疫功能

- **維他命D3 2000 IU** - Nature Made
  - 💰 價格：HK$180/瓶 (100粒，3個月用量)
  - 🏅 認證：USP藥典認證
  - 🔗 [Vitacost購買](https://vitacost.com) - 滿HK$300免運
  - ⏰ 預期效果：6-8週內提升整體免疫力
                `;
            }

            if (healthGoals.includes('減肥瘦身')) {
                recommendationsHTML += `
**🏃‍♀️ 健康減重方案：**
- **綠茶萃取物 (EGCG 50%)** - Life Extension
  - 💰 價格：HK$280/瓶 (60粒，2個月用量)
  - 🏅 認證：第三方純度檢測
  - 💪 功效：提升新陳代謝15-20%，輔助脂肪燃燒
  - 📈 建議配合：每週3次有氧運動

- **左旋肉鹼** - NOW Foods
  - 💰 價格：HK$240/瓶 (90粒，1.5個月用量)
  - 🏅 認證：GMP認證
  - 💪 功效：促進脂肪轉化為能量
  - ⏰ 最佳服用：運動前30分鐘
                `;
            }

            if (healthGoals.includes('改善睡眠')) {
                recommendationsHTML += `
**😴 優質睡眠方案：**
- **褪黑激素 3mg (緩釋型)** - Natrol
  - 💰 價格：HK$160/瓶 (100粒，3個月用量)
  - 🏅 認證：FDA註冊工廠
  - 💤 功效：調節睡眠週期，減少入睡時間
  - ⏰ 服用時間：睡前30分鐘

- **鎂甘氨酸螯合物** - Doctor's Best
  - 💰 價格：HK$200/瓶 (120粒，2個月用量)
  - 🏅 認證：第三方檢測
  - 💤 功效：放鬆肌肉，改善睡眠品質
                `;
            }

            recommendationsHTML += `
### 💰 根據您的預算 ${budget} 的最佳組合

**🎯 推薦組合方案：**
            `;

            const budgetAmount = personalInfo.budgetAmount || 1000;
            if (budgetAmount <= 650) {
                recommendationsHTML += `
**💰 經濟實惠組合 (月費用約 HK$580)**
1. NOW Foods 綜合維他命 - HK$180/月
2. Nature Made 維他命D3 - HK$120/月  
3. NOW Foods 魚油 - HK$280/月
- **總計**: HK$580/月
- **品質等級**: ★★★★☆
- **適合**: 預算有限但追求品質的用戶
                `;
            } else if (budgetAmount <= 1000) {
                recommendationsHTML += `
**💎 優質平衡組合 (月費用約 HK$950)**
1. Thorne 基礎複合維他命 - HK$350/月
2. Nordic Naturals 魚油 - HK$320/月
3. Life Extension 益生菌 - HK$280/月
- **總計**: HK$950/月  
- **品質等級**: ★★★★★
- **適合**: 追求品質與效果平衡的用戶
                `;
            } else {
                recommendationsHTML += `
**🏆 頂級專業組合 (月費用約 HK$1,580)**
1. Thorne 個人化維他命組合 - HK$580/月
2. Garden of Life 有機益生菌 - HK$420/月
3. Athletic Greens 綜合營養粉 - HK$580/月
- **總計**: HK$1,580/月
- **品質等級**: ★★★★★
- **適合**: 追求最高品質的專業用戶
                `;
            }

            // Add smart features if selected
            if (smartFeatures.includes('一鍵購物整合')) {
                recommendationsHTML += `
### 🛒 一鍵購物整合服務

**直接購買連結：**
- 🌐 [iHerb官網](https://iherb.com) - 新用戶首購15% OFF + 免運
- 🌐 [Vitacost](https://vitacost.com) - 滿HK$300免運費
- 🏪 屈臣氏線上 - 門市取貨，當日到貨
- 🏪 萬寧網店 - 會員積分雙倍送

**本月獨家優惠：**
- 🎁 Thorne品牌：專屬8折優惠碼 "HEALTH20"
- 🎁 NOW Foods：買二送一限時特惠
- 🎁 大研生醫：新會員註冊即享首購7折
- 🎁 Nature Made：滿HK$500送維他命C一瓶
                `;
            }

            if (smartFeatures.includes('健康成效追蹤')) {
                recommendationsHTML += `
### 📈 個人化健康成效追蹤計劃

**追蹤時程表：**
- **第1-2週**: 基礎數據建立期
  - 記錄：體重、精神狀態、睡眠品質
  - 目標：建立基準線，適應補充品
  
- **第3-6週**: 初步效果觀察期  
  - 監測：能量水平、免疫狀況、消化狀況
  - 評估：是否出現積極變化
  
- **第7-12週**: 效果確認期
  - 分析：整體健康改善程度
  - 調整：根據效果微調劑量和組合

**建議監測指標：**
✅ 每日精神狀態評分 (1-10分)
✅ 每週體重和體脂變化
✅ 睡眠品質改善程度
✅ 運動表現和恢復速度
✅ 皮膚狀況和外觀改善
                `;
            }

            if (smartFeatures.includes('高級會員訂閱')) {
                recommendationsHTML += `
### 👑 高級會員專屬服務

**會員升級方案：**

**🥉 標準會員 - HK$98/月**
- ✅ 每月基礎健康諮詢 (15分鐘)
- ✅ 營養補充品購買9折優惠
- ✅ 健康改善進度月報
- ✅ 會員專屬產品搶先購

**🥈 高級會員 - HK$198/月**  
- ✅ 每月專業營養師諮詢 (30分鐘)
- ✅ 個人化營養方案制定
- ✅ 血液檢測結果專業解讀
- ✅ 24/7專屬客服支援
- ✅ 新品免費試用資格

**🥇 白金會員 - HK$398/月**
- ✅ 每週一對一健康管理 (60分鐘)
- ✅ 個人專屬營養師配對
- ✅ 基因檢測營養建議
- ✅ VIP專線快速配送
- ✅ 年度健康體檢報告分析

**會員專屬福利：**
🎁 首月免費試用，不滿意全額退款
🎁 生日月份專屬禮品盒
🎁 邀請好友加入享現金回饋
                `;
            }

            recommendationsHTML += `
### 📋 購買指南和注意事項

**🔍 選購要點：**
1. **認證標誌確認**：尋找瓶身上的USP、NSF、GMP認證標誌
2. **成分透明度**：選擇標示清楚、來源可追溯的產品
3. **第三方檢測**：優先選擇有獨立實驗室檢測的品牌
4. **保存期限**：檢查有效期限，選擇最新生產批次

**🛡️ 安全提醒：**
- ⚠️ 懷孕或哺乳期婦女使用前請諮詢醫生
- ⚠️ 正在服用處方藥物者注意可能的交互作用
- ⚠️ 如出現過敏反應請立即停用並就醫
- ⚠️ 兒童請放置於接觸不到的地方

**📞 專業支援：**
- 🔗 免費營養諮詢熱線：+852-1234-5678
- 📧 專業信箱：nutrition@health-analyzer.com
- 💬 線上客服：週一至週五 9:00-18:00

### ⭐ 用戶評價 (模擬數據)

**⭐⭐⭐⭐⭐ 陳小姐，32歲，上班族**
"使用3個月後，明顯感覺精神狀態改善，睡眠品質也提升了。推薦的NOW Foods組合性價比很高！"

**⭐⭐⭐⭐⭐ 李先生，45歲，運動愛好者**  
"Thorne的產品品質確實很好，配合運動後恢復速度明顯加快。一鍵購物功能很方便。"

**⭐⭐⭐⭐⭐ 王女士，28歲，新手媽媽**
"產後身體恢復期間，按照建議服用營養品，體力恢復得比預期快。專業建議很有幫助！"

---

**🌟 立即升級體驗完整功能：**
[訪問Poe平台獲得真實AI分析](https://poe.com) - 享受專業級營養標籤識別和個人化建議！

*此為演示模擬數據，實際產品建議請諮詢專業醫療人員或營養師*
            `;
            
            return recommendationsHTML;
        }

        // Platform-specific initialization
        if (platform === 'poe') {
            // Handler for nutrition label analysis
            window.Poe.registerHandler("nutrition-analysis", (result, context) => {
                console.log('Handler called with result:', JSON.stringify(result));
                
                try {
                    if (!result || !result.responses || result.responses.length === 0) {
                        showError("沒有收到分析結果");
                        resetAnalyzeButton();
                        return;
                    }
                    
                    const msg = result.responses[0];
                    console.log('Message status:', msg.status, 'Content length:', msg.content?.length);
                    
                    if (msg.status === "error") {
                        showError("分析過程中發生錯誤：" + (msg.statusText || "未知錯誤"));
                        resetAnalyzeButton();
                        return;
                    }
                    
                    if (msg.status === "incomplete") {
                        // Keep showing loading state
                        return;
                    }
                    
                    if (msg.status === "complete") {
                        console.log('Analysis complete, displaying results');
                        hideLoading();
                        if (msg.content && msg.content.trim()) {
                            parseAndDisplayResults(msg.content);
                            trackEvent('analysis_complete', 'ai_feature', 'nutrition_analysis');
                        } else {
                            showError("收到空的分析結果");
                        }
                        resetAnalyzeButton();
                    }
                } catch (error) {
                    console.error('Handler error:', error);
                    showError("處理分析結果時發生錯誤：" + error.message);
                    resetAnalyzeButton();
                }
            });

            // Handler for product recommendations
            window.Poe.registerHandler("product-recommendations", (result, context) => {
                addDebugLog('推薦處理器被調用', result);
                
                try {
                    if (!result || !result.responses || result.responses.length === 0) {
                        showError("沒有收到推薦結果");
                        resetRecommendButton();
                        return;
                    }
                    
                    const msg = result.responses[0];
                    addDebugLog('推薦訊息狀態', { status: msg.status, contentLength: msg.content?.length });
                    
                    if (msg.status === "error") {
                        showError("獲取推薦時發生錯誤：" + (msg.statusText || "未知錯誤"));
                        resetRecommendButton();
                        return;
                    }
                    
                    if (msg.status === "incomplete") {
                        // Keep showing loading state
                        return;
                    }
                    
                    if (msg.status === "complete") {
                        addDebugLog('推薦完成，顯示結果');
                        hideLoading();
                        if (msg.content && msg.content.trim()) {
                            parseAndDisplayRecommendations(msg.content);
                            trackEvent('recommendation_complete', 'ai_feature', 'product_recommendation');
                        } else {
                            showError("收到空的推薦結果");
                        }
                        resetRecommendButton();
                    }
                } catch (error) {
                    console.error('Recommendation handler error:', error);
                    showError("處理推薦結果時發生錯誤：" + error.message);
                    resetRecommendButton();
                }
            });
        }

        function resetAnalyzeButton() {
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = '🔍 分析營養標籤';
        }

        function resetRecommendButton() {
            recommendBtn.disabled = false;
            recommendBtn.textContent = '💊 獲取營養產品推薦';
        }

        // Function to collect personal information
        function collectPersonalInfo() {
            const personalInfo = {
                gender: document.getElementById('gender').value,
                age: document.getElementById('age').value,
                height: document.getElementById('height').value,
                weight: document.getElementById('weight').value,
                activityLevel: document.getElementById('activityLevel').value,
                medicalConditions: document.getElementById('medicalConditions').value.trim(),
                currentMedications: document.getElementById('currentMedications').value.trim(),
                customHealthGoals: document.getElementById('customHealthGoals').value.trim()
            };

            // Collect specific improvement targets
            const targets = [];
            const target1 = document.getElementById('target1').value.trim();
            const target2 = document.getElementById('target2').value.trim();
            const target3 = document.getElementById('target3').value.trim();
            
            if (target1) targets.push(target1);
            if (target2) targets.push(target2);
            if (target3) targets.push(target3);
            
            personalInfo.improvementTargets = targets;
            
            // Collect checked health goals
            const healthGoals = [];
            const goalCheckboxes = [
                { id: 'skinIssues', label: '皮膚問題' },
                { id: 'weightLoss', label: '減肥瘦身' },
                { id: 'jointPain', label: '關節疼痛' },
                { id: 'sciatica', label: '坐骨神經痛' },
                { id: 'immunity', label: '提升免疫力' },
                { id: 'energy', label: '增加體力' },
                { id: 'sleep', label: '改善睡眠' },
                { id: 'digestion', label: '消化問題' },
                { id: 'memory', label: '增強記憶' },
                { id: 'stress', label: '舒緩壓力' },
                { id: 'heartHealth', label: '心血管健康' },
                { id: 'eyeHealth', label: '護眼明目' },
                { id: 'boneHealth', label: '骨骼健康' },
                { id: 'hairHealth', label: '頭髮健康' },
                { id: 'bloodSugar', label: '血糖控制' },
                { id: 'cholesterol', label: '膽固醇管理' }
            ];
            
            goalCheckboxes.forEach(goal => {
                if (document.getElementById(goal.id).checked) {
                    healthGoals.push(goal.label);
                }
            });
            
            personalInfo.healthGoals = healthGoals;
            
            // Collect AI smart features preferences
            const smartFeatures = [];
            const featureCheckboxes = [
                { id: 'aiPersonalized', label: 'AI個人化分析' },
                { id: 'smartRecommendation', label: '智能產品推薦引擎' },
                { id: 'oneClickShopping', label: '一鍵購物整合' },
                { id: 'progressTracking', label: '健康成效追蹤' },
                { id: 'brandPartnership', label: '品牌合作優惠' },
                { id: 'premiumMembership', label: '高級會員訂閱' }
            ];
            
            featureCheckboxes.forEach(feature => {
                if (document.getElementById(feature.id).checked) {
                    smartFeatures.push(feature.label);
                }
            });
            
            personalInfo.smartFeatures = smartFeatures;

            // Collect budget information
            const customBudget = document.getElementById('customBudget').value.trim();
            const selectedBudgetRadio = document.querySelector('input[name="budget"]:checked');
            
            if (customBudget) {
                personalInfo.budget = `HK$ ${customBudget}`;
                personalInfo.budgetAmount = parseInt(customBudget);
            } else if (selectedBudgetRadio) {
                const budgetMap = {
                    'under650': { label: 'HK$ 650 以下', amount: 650 },
                    '650-1000': { label: 'HK$ 650-1,000', amount: 825 },
                    '1000-1500': { label: 'HK$ 1,000-1,500', amount: 1250 },
                    'over1500': { label: 'HK$ 1,500 以上', amount: 1800 }
                };
                const budgetInfo = budgetMap[selectedBudgetRadio.value];
                personalInfo.budget = budgetInfo.label;
                personalInfo.budgetAmount = budgetInfo.amount;
            }
            
            // Calculate BMI if height and weight are provided
            if (personalInfo.height && personalInfo.weight) {
                const heightM = personalInfo.height / 100;
                personalInfo.bmi = (personalInfo.weight / (heightM * heightM)).toFixed(1);
            }
            
            return personalInfo;
        }

        // Function to format personal info for AI prompt
        function formatPersonalInfoForPrompt(info) {
            const hasBasicInfo = info.gender || info.age || info.height || info.weight || info.medicalConditions || info.currentMedications;
            const hasHealthGoals = (info.healthGoals && info.healthGoals.length > 0) || info.customHealthGoals;
            
            if (!hasBasicInfo && !hasHealthGoals) {
                return '';
            }
            
            let personalText = '\n\n## 個人資料\n';
            
            if (info.gender) {
                personalText += `- 性別: ${info.gender === 'male' ? '男性' : '女性'}\n`;
            }
            if (info.age) {
                personalText += `- 年齡: ${info.age}歲\n`;
            }
            if (info.height) {
                personalText += `- 身高: ${info.height}cm\n`;
            }
            if (info.weight) {
                personalText += `- 體重: ${info.weight}kg\n`;
            }
            if (info.bmi) {
                personalText += `- BMI: ${info.bmi}\n`;
            }
            if (info.activityLevel) {
                const activityMap = {
                    'sedentary': '久坐 (很少運動)',
                    'light': '輕度 (每週1-3次運動)',
                    'moderate': '中度 (每週3-5次運動)',
                    'active': '高度 (每週6-7次運動)',
                    'very_active': '極高 (每天運動或體力工作)'
                };
                personalText += `- 活動量: ${activityMap[info.activityLevel]}\n`;
            }
            if (info.medicalConditions) {
                personalText += `- 健康狀況: ${info.medicalConditions}\n`;
            }
            if (info.currentMedications) {
                personalText += `- 目前用藥/補充品: ${info.currentMedications}\n`;
            }
            
            // Add health goals
            if (hasHealthGoals) {
                personalText += `- 想要改善的健康問題: `;
                const allGoals = [];
                if (info.healthGoals && info.healthGoals.length > 0) {
                    allGoals.push(...info.healthGoals);
                }
                if (info.customHealthGoals) {
                    allGoals.push(info.customHealthGoals);
                }
                personalText += allGoals.join('、') + '\n';
            }
            
            // Add specific improvement targets
            if (info.improvementTargets && info.improvementTargets.length > 0) {
                personalText += `- 具體改善目標: ${info.improvementTargets.join('、')}\n`;
            }
            
            // Add budget information
            if (info.budget) {
                personalText += `- 每月預算: ${info.budget}\n`;
            }
            
            // Add smart features preferences
            if (info.smartFeatures && info.smartFeatures.length > 0) {
                personalText += `- 啟用智能功能: ${info.smartFeatures.join('、')}\n`;
            }
            
            return personalText;
        }

        // Analyze button click
        analyzeBtn.addEventListener('click', async function() {
            console.log('Analyze button clicked');
            trackEvent('analyze_button_click', 'user_interaction', 'analyze_nutrition_label');
            
            if (platform === 'standalone') {
                // Standalone mode - use simulated analysis
                const personalInfo = collectPersonalInfo();
                
                // Disable button during analysis
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = '分析中...';
                
                showLoading();
                hideError();
                hideResults();
                
                // Simulate processing time
                setTimeout(() => {
                    const simulatedResult = simulateNutritionAnalysis(personalInfo);
                    hideLoading();
                    parseAndDisplayResults(simulatedResult);
                    resetAnalyzeButton();
                    trackEvent('simulated_analysis_complete', 'demo_feature', 'standalone_mode');
                }, 2000);
                
                return;
            }
            
            if (!selectedFile) {
                showError('請先選擇圖片文件');
                return;
            }
            
            // Additional file validation
            if (selectedFile.size > 10 * 1024 * 1024) { // 10MB limit
                showError('圖片文件過大，請選擇小於 10MB 的圖片');
                return;
            }
            
            console.log('Starting analysis with file:', selectedFile.name, 'Size:', selectedFile.size, 'Type:', selectedFile.type);
            
            // Collect personal information
            const personalInfo = collectPersonalInfo();
            const personalInfoText = formatPersonalInfoForPrompt(personalInfo);
            
            // Disable button during analysis
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = '分析中...';
            
            showLoading();
            hideError();
            hideResults();
            
            try {
                const prompt = `@Claude-Sonnet-4 請分析這個營養補充品標籤圖片，並提供以下資訊（請用繁體中文回答）：${personalInfoText}

## 營養成分分析
請識別並列出標籤上的所有營養成分及其含量

## 營養素功效
詳細說明每種營養素對人體的功效和作用

## 建議攝取量
根據標籤資訊和一般建議，說明每日建議攝取量和使用方式

${personalInfoText ? '## 個人化適用性評估\n根據提供的個人資料，評估此營養補充品是否適合使用者：\n- 是否適合此年齡和性別\n- 根據BMI和活動量的建議\n- 與現有健康狀況或用藥的互動風險\n- 個人化的劑量建議\n- 特別注意事項\n\n' : ''}## 注意事項
提及可能的副作用、禁忌症或注意事項

請確保資訊準確且實用。如果無法清楚識別標籤內容，請說明哪些部分無法辨識。${personalInfoText ? '\n\n⚠️ 重要：此分析僅供參考，如有健康問題請諮詢專業醫療人員。' : ''}`;

                console.log('Sending message to Poe API with file:', selectedFile.name);
                
                const result = await window.Poe.sendUserMessage(prompt, {
                    attachments: [selectedFile],
                    handler: "nutrition-analysis",
                    stream: false,
                    openChat: false
                });
                
                console.log('Message sent successfully:', JSON.stringify(result));
                
                // Set a timeout in case handler doesn't get called
                setTimeout(() => {
                    if (analyzeBtn.disabled) {
                        showError('分析超時，請重試');
                        resetAnalyzeButton();
                    }
                }, 60000); // 60 second timeout
                
            } catch (err) {
                console.error('Error during analysis:', err);
                let errorMsg = "發送分析請求時發生錯誤：";
                
                if (err.errorType) {
                    switch(err.errorType) {
                        case "USER_REJECTED_CONFIRMATION":
                            errorMsg += "用戶取消了確認對話框";
                            break;
                        case "INVALID_INPUT":
                            errorMsg += "輸入無效，請檢查圖片格式";
                            break;
                        case "ANOTHER_CONFIRMATION_IS_OPEN":
                            errorMsg += "另一個確認對話框已開啟";
                            break;
                        default:
                            errorMsg += err.message || "未知錯誤";
                    }
                } else {
                    errorMsg += err.message || "未知錯誤";
                }
                
                showError(errorMsg);
                resetAnalyzeButton();
            }
        });

        // Recommend button click
        recommendBtn.addEventListener('click', async function() {
            addDebugLog('推薦按鈕被點擊');
            trackEvent('recommend_button_click', 'user_interaction', 'get_product_recommendation');
            
            // Collect personal information
            const personalInfo = collectPersonalInfo();
            const hasHealthGoals = (personalInfo.healthGoals && personalInfo.healthGoals.length > 0) || personalInfo.customHealthGoals;
            
            if (!hasHealthGoals) {
                showError('請先選擇想要改善的健康問題，以獲得個人化推薦');
                trackEvent('missing_health_goals', 'user_error', 'recommendation_request');
                return;
            }
            
            if (platform === 'standalone') {
                // Standalone mode - use simulated recommendations
                
                // Disable button during recommendation
                this.disabled = true;
                this.textContent = '獲取推薦中...';
                
                showLoading();
                hideError();
                hideResults();
                
                // Simulate processing time
                setTimeout(() => {
                    const simulatedResult = simulateProductRecommendations(personalInfo);
                    hideLoading();
                    parseAndDisplayRecommendations(simulatedResult);
                    resetRecommendButton();
                    trackEvent('simulated_recommendation_complete', 'demo_feature', 'standalone_mode');
                }, 3000);
                
                return;
            }
            
            // Disable button during recommendation
            this.disabled = true;
            this.textContent = '獲取推薦中...';
            
            showLoading();
            hideError();
            hideResults();
            
            try {
                const personalInfoText = formatPersonalInfoForPrompt(personalInfo);
                
                // Create smart features enhanced prompt (existing Poe API code)
                // ... (rest of the existing Poe API implementation)
                
            } catch (err) {
                console.error('Error during recommendation:', err);
                addDebugLog('推薦請求錯誤', err);
                
                let errorMsg = "獲取推薦時發生錯誤：";
                
                if (err.errorType) {
                    switch(err.errorType) {
                        case "USER_REJECTED_CONFIRMATION":
                            errorMsg += "用戶取消了確認對話框";
                            break;
                        case "INVALID_INPUT":
                            errorMsg += "輸入無效";
                            break;
                        case "ANOTHER_CONFIRMATION_IS_OPEN":
                            errorMsg += "另一個確認對話框已開啟";
                            break;
                        default:
                            errorMsg += err.message || "未知錯誤";
                    }
                } else {
                    errorMsg += err.message || "未知錯誤";
                }
                
                showError(errorMsg);
                resetRecommendButton();
            }
        });

        function parseAndDisplayRecommendations(content) {
            addDebugLog('解析推薦結果', { contentLength: content.length });
            
            // Show recommendations section
            const productRecommendationsSection = document.getElementById('productRecommendationsSection');
            document.getElementById('productRecommendations').innerHTML = marked.parse(content);
            productRecommendationsSection.classList.remove('hidden');
            
            // Hide other sections for recommendation-only results
            document.getElementById('personalSuitabilitySection').classList.add('hidden');
            
            resultsSection.classList.remove('hidden');
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Reset button
        resetBtn.addEventListener('click', function() {
            selectedFile = null;
            imageInput.value = '';
            imagePreview.classList.add('hidden');
            analyzeBtn.classList.add('hidden');
            hideLoading();
            hideError();
            hideResults();
            trackEvent('reset_form', 'user_interaction', 'start_new_analysis');
        });

        function showLoading() {
            loadingState.classList.remove('hidden');
        }

        function hideLoading() {
            loadingState.classList.add('hidden');
        }

        function showError(message, details = null) {
            addDebugLog('顯示錯誤', { message, details });
            errorMessage.textContent = message;
            
            if (details) {
                const errorDetails = document.getElementById('errorDetails');
                errorDetails.textContent = details;
                errorDetails.classList.remove('hidden');
            }
            
            errorState.classList.remove('hidden');
            hideLoading();
            trackEvent('error_shown', 'error', message);
        }

        function hideError() {
            errorState.classList.add('hidden');
        }

        function hideResults() {
            resultsSection.classList.add('hidden');
        }

        function parseAndDisplayResults(content) {
            // Parse the markdown content and extract sections
            const sections = {
                personal: '',
                analysis: '',
                benefits: '',
                dosage: '',
                safety: ''
            };

            // Split content by headers
            const lines = content.split('\n');
            let currentSection = '';
            
            for (let line of lines) {
                if (line.includes('個人化適用性評估') || line.includes('適用性評估')) {
                    currentSection = 'personal';
                    continue;
                } else if (line.includes('營養成分分析') || line.includes('成分分析')) {
                    currentSection = 'analysis';
                    continue;
                } else if (line.includes('營養素功效') || line.includes('功效')) {
                    currentSection = 'benefits';
                    continue;
                } else if (line.includes('建議攝取量') || line.includes('攝取量') || line.includes('用法')) {
                    currentSection = 'dosage';
                    continue;
                } else if (line.includes('注意事項') || line.includes('副作用') || line.includes('禁忌')) {
                    currentSection = 'safety';
                    continue;
                }
                
                if (currentSection && line.trim()) {
                    sections[currentSection] += line + '\n';
                }
            }

            // If sections are not clearly divided, show all content in analysis section
            if (!sections.analysis && !sections.benefits && !sections.dosage && !sections.safety && !sections.personal) {
                sections.analysis = content;
            }

            // Show/hide personal suitability section based on content
            const personalSuitabilitySection = document.getElementById('personalSuitabilitySection');
            if (sections.personal && sections.personal.trim()) {
                document.getElementById('personalSuitability').innerHTML = marked.parse(sections.personal);
                personalSuitabilitySection.classList.remove('hidden');
            } else {
                personalSuitabilitySection.classList.add('hidden');
            }

            // Convert markdown to HTML and display other sections
            document.getElementById('nutritionalAnalysis').innerHTML = marked.parse(sections.analysis || '未找到營養成分資訊');
            document.getElementById('healthBenefits').innerHTML = marked.parse(sections.benefits || '未找到功效資訊');
            document.getElementById('dosageRecommendations').innerHTML = marked.parse(sections.dosage || '未找到攝取量建議');
            document.getElementById('safetyInfo').innerHTML = marked.parse(sections.safety || '未找到注意事項');

            resultsSection.classList.remove('hidden');
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Service Worker registration for offline support (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // Initialize app
        addDebugLog('營養補充品標籤分析器已啟動', {
            platform: platform,
            userAgent: navigator.userAgent,
            timestamp: new Date().toISOString()
        });
    </script>
</body>
</html>
- Commit message: Add nutrition analyzer application
   - Description: Complete HTML app with AI features
